# MicroDynamics开发者日志

---
## 2016.07.05

**作者：**<br>
myyerrol<br>

**完成：**<br>
1、完成MicroDynamics团队整体项目的规划工作。<br>
2、确定了GitHub团队组织仓库的基本管理方案。<br>

**计划：**<br>
1、尽快在接下来的几天内完成团队的开发风格指南。<br>
2、学习Qt界面编程，编写出简单的项目界面。<br>

---
## 2016.07.06

**作者：**<br>
maksyuki<br>

**完成：**<br>
1、经过讨论后完成了团队标志的初步设计工作。<br>
2、制定了暑假Breeze无人机嵌入式部分算法设计的开发计划。<br>

**计划：**<br>
1、通过相关书籍和网络来学习STM32开发的基本知识和流程。<br>
2、进一步学习并掌握以PID为基础的控制算法，熟悉无人机飞行相关知识。<br>

---
## 2016.07.06-07.12

**作者：**<br>
myyerrol<br>

**完成：**<br>
1、搞定了团队开发风格指南。<br>
2、完成了Breeze无人机飞行控制站的基础界面设计。<br>

**计划：**<br>
1、配置并优化界面。<br>
2、学习无人机通信协议，尽快把协议整合到Breeze无人机飞行控制站中。<br>

---
## 2016.07.22

**作者：**<br>
myyerrol<br>

**完成：**<br>
1、已将串口协议整合到Breeze无人机飞行控制站中。<br>
2、简化图形界面。<br>

**计划：**<br>
1、配置STM32开发环境。<br>
2、将通信协议添加到STM32代码中。<br>

---
## 2016.07.24

**作者：**<br>
maksyuki<br>

**计划：**<br>
1、深入了解开源飞控算法中关于高度融合部分的代码，进而实现Breeze沿Z轴方向的定高悬停。<br>
2、从整体上把握开源飞控算法在任务调度、执行方面的实现。<br>

---
## 2016.08.12

**作者：**<br>
myyerrol<br>

**完成：**<br>
1、配置完成STM32开发环境。<br>
2、完善STM32开发模板。<br>

**计划：**<br>
1、搜集与PCB设计相关的书籍或资料，开始学习PCB的设计。<br>
2、参考Crazypony的PCB，保持功能不变，只修改外观设计。<br>

---
## 2016.08.13

**作者：**<br>
maksyuki<br>

**完成：**<br>
1、完成飞控算法中相关寄存器的配置和驱动的编写。<br>
2、对于STM32中SPI、IIC总线和PWM驱动进行了相关的测试。<br>

**计划：**<br>
1、实现DMA驱动的编写并实现无人机LED灯语的设计和编程。<br>

---
## 2016.08.23

**作者：**<br>
myyerrol<br>

**完成：**<br>
1、完成Breeze无人机元器件和封装库的设计与配置。<br>
2、画完Breeze无人机原理图。<br>

**问题：**<br>
1、在画原理图的时候，我发现整个系统中存在着很多不同功能的电源。这些电源分布在机体的各处，与很多IC都存在关系。我想这个需要花一些时间来弄明白，因为这对之后PCB中的电源设计是至关重要的。<br>

**计划：**<br>
1、搞定原理图中的电源关系。<br>
2、开始着手设计PCB的布局，并尽快完成最后总体的布线工作。<br>

---
## 2016.08.28

**作者：**<br>
maksyuki<br>

**完成：**<br>
1、完成Breeze无人机飞控算法中所有底层驱动模块的编写并用库函数重写了SPI驱动。<br>
2、实现了NRF24L01无线系统模块的编写，无人机和遥控器可以进行匹配并传送数据<br>

**问题：**<br>
1、在我编写完系统主时钟驱动模块后，想测试一下在系统中断存在的情况下PWM输出驱动电机的情况。结果发现电机在输入值都是10的情况下出现嘶嘶声。开始还觉得是电池电压不够造成的，后来经过多次的烧写和在线调试，发现PWM输出值的范围是100~999。<br>

**计划：**<br>
1、实现系统传感器(IMU、气压计)的初始化操作。<br>
2、优化先前编写的代码。<br>

---
## 2016.09.12

**作者：**<br>
myyerrol<br>

**完成：**<br>
1、搞定部分模块的布局问题。<br>
2、修改元件安全间隔为0.15毫米。<br>

**问题：**<br>
1、在对Breeze无人机进行完第二次PCB布局后，我发现无论我怎样放置模块，都很难将元器件彼此分开。这会导致在布线的时候，PCB上没有足够的空间来走线。<br>

**解决：**<br>
1、适当地在PCB的背面布一部分的元器件模块。<br>

**计划：**<br>
1、完成Breeze无人机剩下模块的布局。<br>
2、尽快进行双面的PCB布线。<br>

---
## 2016.09.19

**作者：**<br>
myyerrol

**完成：**<br>
1、搞定Breeze四轴电机、传感器和电源等模块的PCB布线。<br>
2、修复原理图中的一些错误。<br>

**问题：**<br>
1、在进行PCB布线的时候，我发现KiCad自带的自动布线功能实在是非常有限，而自己使用手工布线问题又非常多。比如信号线的拐弯处成锐角或直角、板子的过孔过多等。<br>

**解决：**<br>
1、经过一段时间的网上搜索，我终于找到了解决方案。问题的解法就是使用KiCad带有的交互式布线功能（这个功能需要先开启对OpenGL的支持）。这种布线模式最大的好处就是可以在布线的时候通过挤压其他导线来自动地处理它们之间的位置关系，从而极大地减少了因导线交叉而使用过孔的问题。而且整条导线根据拐弯处被划分成若干条线段，这样有利于对布线的角度进行精确的修改。<br>

**计划：**<br>
1、尽快完成对PCB剩余模块的布线。<br>
2、拆分原先的原理图，并按照模块进行划分。<br>

---
## 2016.10.08

**作者：**<br>
maksyuki

**完成：**<br>
1、完成Breeze飞行控制部分代码的编写。<br>

**计划：**<br>
1、尽快实现通信中有关油门数据的发送和转换部分的代码。<br>
2、进行Breeze整机飞控代码的测试。<br>

---
## 2016.10.19

**作者：**<br>
maksyuki

**完成：**<br>
1、完成油门数据的接收和转换计算部分代码的编写。<br>
2、完成整机飞控代码中关于硬件驱动初始化部分相关函数的整理、重写和测试。<br>

**问题：**<br>
1、在进行相关硬件驱动初始化测试的过程中，发现程序运行到MS5611_WaitBaroInitOffset()函数处出现死循环的情况。结合串口输出和软件debug最终发现是其中调用的计时函数micros()由于没有开启系统定时器SysTick中断来累加计数得到确定的时间，导致micros()一直返回0。另外同时出现delay_us()和delay_ms()函数同时使用SysTick计数和micros()函数冲突进而导致延时不稳定的情况。<br>

**解决：**<br>
1、这里采用外接晶振并通过PLL倍频到72Mz来取代原先的内部时钟信号，作为整个系统的时钟源。按照STM32所提供的技术参考手册上的配置方式配置并开启SysTick定时中断。delay_us()和delay_ms()函数不再采用SysTick定时器作为定时标准，这里直接采用定时中断累加实现。<br>

**计划：**<br>
1、开始着手测试利用主定时器实现中断嵌套功能部分的代码。<br>
2、进行IMU数据的标定和姿态融合算法的测试。<br>

---
## 2016.10.26

**作者：**<br>
maksyuki

**完成：**<br>
1、完成利用主定时器实现中断嵌套功能部分代码的编写。<br>
2、完成整机飞控代码中涉及到姿态和油门控制的部分，经过简单测试Breeze可以保持一个基本的姿态稳定和定高悬停。<br>

**说明：**<br>
1、Breeze基本上实现了稳定控制，代码按照驱动级、外设级和算法级进行了分类，便于修改和维护。在实际测试过程中发现机体遇到障碍物时会出现电机座断裂和断桨的情况，这说明在机械强度设计上还需要考虑更多。比如采用和Tiny Whoop类似的涵道支架设计，这样可以在保持外形美观的情况下有效减少断桨的情况。另外可以参考crazyfile橡胶电池座的设计来减少底座断裂的情况。<br>

**计划：**<br>
1、优化飞控代码的结构并添加必要的注释和说明。<br>
2、实现一键起飞、定高，一键降落的功能。对于姿态解算部分采用卡尔曼滤波算法来代替原来的Mahony互补滤波算法，以达到更高的解算精度。<br>
3、在STM32上构建FreeRTOS，并在FreeRTOS上完整移植飞控算法。<br>

---
## 2017.01.15

**作者：**<br>
myyerrol

**完成：**<br>
1、配置了Cadence 16.6 EDA开发工具。<br>
2、搭建了Git版本控制系统。<br>

**计划：**<br>
1、学习Cadence的基本使用，掌握原理图和PCB的制作方法。<br>
2、阅读《ARM Contrex-A8 硬件设计DIY》，制定详细的设计方案。<br>

---
## 2017.01.21

**作者：**<br>
myyerrol

**完成：**<br>
1、学习了天嵌E8开发板的相关开发资料。<br>
2、收集了一些其他微型四轴飞行器的资料。<br>

**计划：**<br>
1、尽快将固件烧写到天嵌E8开发板中，学会基本的ARM配置过程。<br>
2、根据E8实际运行的效果和之前Phenox2的相关资料，最终确定整个硬件设计方案。<br>

---
## 2017.02.22

**作者：**<br>
myyerrol

**完成：**<br>
1、完成MyCrazyfile无人机的打板工作。<br>
2、购买了足够的元器件。<br>

**计划：**<br>
1、学习MyCrazyfile无人机的PCB工程并在它的基础上做一定的修改。<br>
2、尽可能快地完成MyCrazyfile无人机的焊接工作。<br>

---
## 2017.03.05

**作者：**<br>
myyerrol

**完成：**<br>
1、确定了Breeze无人机各模块的原理图和元器件的具体型号、封装。<br>
2、制作了团队的原理图和PCB模板文件。<br>
3、完成了对元件库和封装库的绘制工作。<br>
4、绘制了各模块的原理图并通过了ERC检查。<br>
5、绘制Breeze无人机的PCB外轮廓并对PCB的层数等参数进行了相应的配置。<br>
6、完成元器件封装在PCB上的合理布局。<br>

**问题：**<br>
1、使用Altium Designer修改完原理图的一些电气连接，并将更改同步到PCB中的时候，出现**Unknown Pin**和**Failed to add class member**形式的错误。<br>
2、我在完成对所有封装的布局后，发现有两个贴片的单刀双掷开关是卧式的，而我不小心把它们布到了紧邻排插的旁边。而如果要修改这两个开关的布局又会引起连锁反应，导致其他元件封装的位置也要修改，非常费时费力。<br>

**解决：**<br>
1、我上完查了不少解决方法，但基本上都要新建个PCB文件才能解决，但这样会导致要放弃自己之前已完成的封装布局，而重新布局费时又劳神。最后，经过不断地搜索，我终于找到了完美解决的办法。<br>
（1）、使用快捷键D+N+N，打开Netlist Manager，删除板子上的所有Net。<br>
（2）、使用快捷键D+C，打开Object Class Explorer，删除Component Classes中与项目有关的所有Class。<br>
（3）、选择重新从原理图中导入就没有问题了。<br>
2、我后来选择更改原理图，直接将原来的两个单刀双掷开关改为一个双刀双掷开关，而且这次在器件选型的时候采用立式2mm的贴片封装。这样，在不对其他器件封装位置做出修改的情况下，只要将新的开关封装放置到原先那两个的位置上就可以了。<br>

**计划：**<br>
1、在一周内完成对Breeze无人机PCB的全部布线工作。<br>
2、根据原理图，完成对无人机PCB板的焊接。<br>
3、开始搭建嵌入式软件开发环境，并尝试烧写一些示例代码。<br>

---
## 2017.03.12

**作者：**<br>
myyerrol

**完成：**<br>
1、根据DRC重新对元器件进行了正确且合理的布局。<br>
2、完成了对所有信号层网络的布线工作。<br>
3、完成了对中间层VCC和GND的电源分割。<br>
4、对信号层的模拟地和数字地进行了双面覆铜并添加过孔。<br>
5、改正了所有DRC检查时出现的违反规则的设计。<br>
6、最后对所有焊盘进行了补泪滴的操作。<br>

**问题：**<br>
1、在手动给QFN封装的中间散热焊盘添加DGND网络时，出现多个DRC报错，错误内容是中间焊盘和焊盘上的多个过孔之间发生了碰撞。<br>
2、在覆铜的时候，有些布局靠内部的元件焊盘并没有被覆上铜，导致在DRC检查时报错。<br>

**解决：**<br>
1、经过在Google上的搜索之后，我找到了问题的原因和解决办法。错误原因是没有给过孔添加同样的DGND网络，导致DRC误报。解决办法是在出错变绿的地方按下Shitf+V，调出Board Insight管理器，然后在里面逐一对过孔的网络属性进行修改。<br>
2、解决办法是拉大内部元件之间的空间，使其与外围的覆铜切面要尽可能的大。对于那些实在无法与其他地层相连的覆铜，可以使用过孔的方式，将其划分到相应的电源分割层中去。<br>

**计划：**<br>
1、认真、仔细地完成无人机PCB板的焊接和调试工作。<br>
2、在Ubuntu上搭建嵌入式软件开发环境，并学习基本的软件编译和烧写方法。<br>
3、学习其他开源飞控的代码，并根据自己无人机的硬件，对其代码进行适当的重构。<br>

---
## 2017.03.19

**作者：**<br>
myyerrol

**完成：**<br>
1、学会Makefile并成功在Ubuntu上搭建了STM32嵌入式软件开发环境。<br>
2、完成了无人机基本的元器件焊接。<br>

**问题：**<br>
1、在焊接贴片电阻和电容的时候，总是会出现焊锡过多而呈球形粘连在焊盘边缘的情况。<br>

**解决：**<br>
1、更换了头更尖的锡焊枪，并注意用湿海绵来擦除焊枪头上过多的焊锡。<br>

**计划：**<br>
1、学习如何焊接QFN形式的封装，并尝试在无人机上进行实际的操作。<br>
2、完成无人机剩余外围接口元件的焊接，并预留电源接口给将来需要搭载的摄像头模块。<br>
3、继续学习其他开源飞控。<br>
4、尝试在Ubuntu上配置并测试图传模块。<br>

---
## 2017.03.29

**作者：**<br>
myyerrol

**完成：**<br>
1、完成了无人机元器件的焊接工作。<br>

**计划：**<br>
1、对焊接完成的无人机进行基本的测试。<br>
2、开始将原来使用Keil编写的飞控代码移植到Linux上。<br>
3、继续学习开源飞控算法。<br>

---
## 2017.04.04

**作者：**<br>
myyerrol

**完成：**<br>
1、完成了无人机部分电路模块的硬件调试工作。<br>
2、实践并总结了硬件电路焊接的相关经验。<br>

**问题：**<br>
1、在Ubuntu下使用J-Link的SWD模式给无人机主控烧写范例程序时，总是在**init**阶段报错，无法继续进行下去。可是我后来又尝试着给STM32最小系统板和Crazepony无人机烧写程序，均没有出现问题。<br>

**解决：**<br>
1、根据错误信息，我首先对QFN封装的STM32F103T6U6芯片进行了全方位的检查，发现**Boot0**引脚和旁边的**NRST**引脚直接短路连接在了一起。改正这个错误后，问题还是没有得到解决。此时，有两种可能性。一种是芯片供电电压不对，另一种就比较悲催了，那就是芯片已被焊坏，无法修复。我首先验证了第一种情况，这一测还真把我吓了一跳，给芯片供电的数字电源电压竟然高达5V，已经超过了STM32F103T6U6芯片手册中所允许的最大4V的限制，我又测了一下模拟电源的电压，发现正常，那么造成数字电压不为3.3V的唯一解释就是管理数字电源的TPS79301低压差线性稳压器电路出现了问题。后来，我对该降压电路进行了仔细的检查，发现有个虚焊。补焊后，问题依然存在，随后我更换了TPS79301芯片，电压过高的问题终于得到了解决，可是STM32F103T6U6的初始化问题依然存在，我想唯一的可能就是主控芯片已坏。至于坏掉的原因，我认为有两种：一种是我当初选择用吹风机来焊接芯片，操作时缺乏经验，使得芯片因为温度过高而坏。另一种则是由于刚才的电压过高问题，导致芯片出现了不可逆的损坏。<br>

**总结：**<br>
1、在对整个硬件系统进行焊接的时候，一定要先根据模块功能对焊接顺序进行确定，这一点十分重要！以MyCrazyfile无人机为例，应该先完成对电源电路的焊接工作。因为电源是其他电路模块运行的基础，而且电源的种类有很多（数字、模拟、USB、电池等）。如果电源出现问题，那对整个系统的损害是非常严重的（就像我上面遇到的问题）！电源部分焊接完成并且测试没有问题之后，应该紧接着焊接主控部分，要确保范例程序可以烧写到其中。在保证前面两个电路模块绝对没有出现问题之后，就可以根据具体功能需求，完成对剩下电路的的焊接工作了。<br>
2、在焊接某个具体电路模块的时候，要遵守先焊IC，再焊电阻、电容等常规贴片元器件，最后焊接开关、USB或接线端子类的器件的顺序。<br>
3、如果焊错了某个元件，在拆焊的时候一定要提高警惕！不要用电烙铁长时间加热焊盘，而且在使用吸锡器吸走焊盘上焊锡的时候，一定要小心！由于其强大的吸力，有很大的可能会导致焊盘直接从PCB板上剥落，和焊锡一起被吸入到吸锡器中。如果出现了这种情况，我想任何人也都没有办法帮你去解决。我就两次遇到了此种情况。如果幸运的话，你可以使用焊锡搭焊或者飞线的方式来补救，但不要期求每次你都能有这么好的运气。所以，在第一次焊接的时候就要仔细、认真，如果真出现了焊错的情况，推荐使用吸锡线或者杜邦线来将多余的焊锡刮走，这样做会安全很多。<br>
4、在焊接QFN或LPCC形式的封装时，推荐直接使用刀型或马蹄形的可调温电烙铁来焊接。如果QFN封装中间的矩形散热焊盘有连接到电路中的GND、AGND或者DNGD时，也优先使用电烙铁而不是吹风机。具体的焊接过程如下：先分别在IC引脚和PCB焊盘上涂上适量的焊锡膏，并用电烙铁的拖焊方式给IC和PCB焊盘都上上足够的锡（对于散热焊盘接地的情况，请在相应的位置上上少量的锡，而且一定要刮平）。然后，给上过锡的PCB焊盘在涂上适量的焊锡膏，用镊子小心、仔细地把芯片的引脚和PCB焊盘匹配起来。接着给电烙铁上锡，使用拖焊的方式完成芯片四周的焊接。特别要注意：QFN封装四周露在外面的焊点非常小，如果一次没能都拖焊上，多拖几次就行了。

**计划：**<br>
1、继续将之前开发的飞控程序移植到Uubntu上。<br>
2、开始制定无人机的数据通信协议。<br>
3、最后重新再对MyCrazyfile无人机进行一次焊接。<br>

---
## 2017.04.06

**作者：**<br>
myyerrol

**完成：**<br>
1、完成对Ubuntu下飞控开发环境的配置。<br>
2、学习了链接脚本的基本知识。<br>

**问题：**<br>
1、使用**make all**命令进行编译、链接的时候，编译器报错：**undefined reference to \`_sbrk'**。<br>
2、在解决完问题1后再次编译整个工程，编译器依然报错：**undefined reference to \`end'**。<br>

**解决：**<br>
1、在Google上搜索了一番，找到了解决方法。报错的原因是没有在链接的时候指定系统调用**syscalls**，因此只需要在链接参数中添加下面例子中的参数就可以：<br>

```makefile
arm-none-eabi-gcc --specs=rdimon.specs $(OTHER_LINK_OPTIONS)
```

2、出现这个问题的原因主要是**end**符号没有被定义在堆的起始部分。解决方法是修改链接脚本文件，在**BSS**段后面添加如下的内容即可：<br>

```text
. = ALIGN(4);
end = . ;
```

**计划：**<br>
1、继续学习飞控代码，其中要重点理解2.4G无线通讯协议。<br>
2、准备接下来对MyCrazyfile无人机的焊接工作。
